stages:
  - test
  - deploy

pytest:
  stage: test
  tags: [ nix ]
  script:
    - nix develop . --command poetry install
    - nix develop . --command poetry run pytest

pypi_deploy:
  stage: deploy
  tags: [ nix ]
  image: $PYTHON_IMAGE
  script:
    - nix develop . --command poetry install
    - nix develop . --command poetry config pypi-token.pypi "$PYPI_TOKEN"
    # Extract the version number from pyproject.toml
    - VERSION=$(nix develop . --command poetry version -s)
    # Check if the version already exists on PyPI for jinko-sdk using the HTTP status code
    - response=$(curl -s -o /dev/null -w "%{http_code}" https://pypi.org/pypi/jinko-sdk/$VERSION/json)
    - if [ "$response" -eq 200 ]; then echo "Version $VERSION already exists on PyPI. Skipping deployment."; exit 0; fi
    - nix develop . --command poetry publish --build
  environment:
    name: production
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
